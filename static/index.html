<html>
<head>
<script type="text/javascript" src='/static/js/jquery-1.7.1.min.js'></script>
<script src="/static/js/jquery.tmpl.min.js" type="text/javascript"></script>
<script src="/latest_event/" type="text/javascript"></script>

<script type="text/javascript">
$(document).ready(function() {
    // is connected???

    $.template("callerBlock", '<div ' +
            'started="${time}" ' +
            'style="margin:5px;background-color:red;" ' +
            'class="caller caller_${callid}">' +
            '${callerid}' +
            '<span class="agent_${callid}"></span>' +
    '</div>');

    $.template("agentBlock", '<div ' +
            'style="margin:5px;background-color:blue;" ' +
            'class="agent agent_${agent}">' +
            '${agent}' +
    '</div>');

    function update_counter(counter_name) {
        counter_name = '#' + counter_name;
        $(counter_name).html(parseInt($(counter_name).html()) + 1);
    }

    function callers_controller(data) {
        if (data.event == 'ENTERQUEUE') {
            $.tmpl("callerBlock", data).appendTo('#callers');

            console.log('add caller ' + data.callid);
        }

        if (   data.event == 'COMPLETEAGENT'
            || data.event == 'COMPLETECALLER'
            || data.event == 'TRANSFER'
            || data.event == 'ABANDON')
        {
            $('.caller_' + data.callid).remove();
        }

        if (data.event == 'CONNECT') {
            $('.agent_' + data.callid).html(' -> ' + data.agent);
            $('.caller_' + data.callid).css('background-color', 'green');
        }
    }

    function agents_controller(data) {
        if (   data.event == 'COMPLETEAGENT'
            || data.event == 'COMPLETECALLER'
            || data.event == 'TRANSFER'
            || data.event == 'CONNECT'
            || data.event == 'RINGNOANSWER')
        {
            if ($('.agent_' + data.agent).length == 0 ) {
                $.tmpl("agentBlock", data).appendTo('#agents');
            }
        }

        if (data.event == 'REMOVEMEMBER')
        {
            $('.agent_' + data.agent).remove();
        }
    }

    function links_controller(data) {
    }

    function layout_controller(data) {
        $('#log').append(data.time + ' ' + data.event + ' ' + data.callid + '\n');

        if (   data.event == 'COMPLETEAGENT'
            || data.event == 'COMPLETECALLER'
            || data.event == 'TRANSFER')
        {
            update_counter('total_successful');
        }

        if (   data.event == 'ABANDON'
            || data.event == 'TIMEOUT')
        {
            update_counter('total_unsuccessful');
        }

        if (data.event == 'COMPLETEAGENT') {
            update_counter('total_completeagent');
        }

        if (data.event == 'COMPLETECALLER') {
            update_counter('total_completecaller');
        }

        if (data.event == 'TRANSFER') {
            update_counter('total_transfer');
        }

        if (data.event == 'ABANDON') {
            update_counter('total_abandon');
        }

        if (data.event == 'TIMEOUT') {
            update_counter('total_timeout');
        }
    }

    function schedule_controller() {
        console.log('run periodic task');
    }

    function poll(){
        $.ajax({
    	    url: "/getevents/" + last_event, 

            success: function(data){
                callers_controller(data);
                agents_controller(data);
                links_controller(data);
                layout_controller(data);

                last_event = data.id;
    	    },

    	    error: function(error){
                console.log(error);
    	    }, 

    	    dataType: "json",
    	    complete: poll, 
    	    timeout: 60000
    	});
    }
    
    poll();
    setInterval(schedule_controller, 5000);
});

</script>

</head>
<body>
<table width="100%">
<tr valign="top">
<td width="70%"><textarea cols="80" rows="10" id="log"></textarea></td>
<td><span>total answered: <span id="total_successful">0</span></span><br />
<span>total finished by agent: <span id="total_completeagent">0</span></span><br />
<span>total finished by caller: <span id="total_completecaller">0</span></span><br />
<span>total abandoned: <span id="total_abandon">0</span></span><br />
<span>total timeouted: <span id="total_timeout">0</span></span><br />
<span>total transfered: <span id="total_transfer">0</span></span>
<span>total unsuccessful: <span id="total_unsuccessful">0</span></span></td>
</tr>
</table>
<table width="100%">
<tr valign="top">
<td width="70%" id="callers"></td>
<td id="agents"></td>
</tr>
</table>
</body>
</html>
