<html>
<head>
<script type="text/javascript" src='/static/js/jquery-1.7.1.min.js'></script>
<script src="/static/js/jquery.tmpl.min.js" type="text/javascript"></script>
<script src="/latest_event/" type="text/javascript"></script>

<script type="text/javascript">
$(document).ready(function() {
    // is connected???

    $.template("callerBlock", '<div ' +
            'started="${time}" ' +
            'style="margin:5px;background-color:red;" ' +
            'class="caller caller_${callid}">' +
            '${data}' +
    '</div>');

    function caller_controller(data) {
        if (data.event == 'ENTERQUEUE') {
            $.tmpl("callerBlock", data).appendTo('#callers');

            console.log('add caller ' + data.callid);
        }

        if (   data.event == 'COMPLETEAGENT'
            || data.event == 'COMPLETECALLER'
            || data.event == 'TRANSFER'
            || data.event == 'ABANDON')
        {
            $('.caller_' + data.callid).remove();
        }

        if (data.event == 'CONNECT') {
            $('.caller_' + data.callid).css('background-color', 'green');
        }
    }

    function agent_controller(data) {
    }

    function layout_controller(data) {
        $('#test').append(data.time + ' ' + data.event + ' ' + data.callid + '\n');
    }

    function poll(){
        $.ajax({
    	    url: "/getevents/" + last_event, 

            success: function(data){
                caller_controller(data);
                agent_controller(data);
                layout_controller(data);

                last_event = data.id;
    	    },

    	    error: function(error){
                console.log(error);
    	    }, 

    	    dataType: "json",
    	    complete: poll, 
    	    timeout: 60000
    	});
    }
    
    poll();
});

</script>

</head>
<body>
<textarea cols="80" rows="10" id="test"></textarea>

<div id="callers"></div>
</body>
</html>
