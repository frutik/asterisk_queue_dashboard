<html>
<head>
<script type="text/javascript" src='/static/js/jquery-1.7.1.min.js'></script>
<script src="/static/js/jquery.tmpl.min.js" type="text/javascript"></script>
<script src="/get_latest_event/" type="text/javascript"></script>

<script type="text/javascript">
$(document).ready(function() {
    // is connected???
    
    var last_event = '285811';
    
    function caller_controller(data) {
	if (data.event == 'ENTERQUEUE') {
	    $('#callers').append('<div style="background-color:red;" class="caller_' + data.callid + '">' + data.data + '</div>');
	    console.log('add caller ' + data.callid);
	}

	if (data.event == 'COMPLETEAGENT' || data.event == 'COMPLETECALLER') {
	    console.log('remove caller ' + data.callid);
	    $('.caller_' + data.callid).remove();
	}

	if (data.event == 'CONNECT') {
	    $('.caller_' + data.callid).css('background-color', 'green');
	}
    }

    function agent_controller(data) {
    }
    
    function poll(){
        $.ajax({
    	    url: "/getevents/" + last_event, 
    	    success: function(data){

		    $('#test').append(data.time + ' ' + data.event + ' ' + data.callid + '\n');
		    
		    caller_controller(data);
		    agent_controller(data);
		    
		    last_event = data.id;
                        
    	    }, 
    	    error: function(error){
		console.log('ERROR');
		console.log(error);
    	    }, 
    	    dataType: "json", 
    	    complete: poll, 
    	    timeout: 5000 
    	});
    }
    
    poll();
    
});

</script>

</head>
<body>
<textarea cols="80" rows="10" id="test"></textarea>

<div id="callers"></div>
</body>
</html>
